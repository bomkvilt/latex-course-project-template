% -----------------| definitions.bgn
% >>
\bool_new:N \sections@bInSection    % if a current code is a sections inside
\bool_new:N \sections@binSubSection % if a current code in a subsection

\seq_new:N \sections@reg@sectionNames_seq  % list of sections was already added
\seq_new:N \sections@reg@appendixPaths_seq % list of appendix pathes to be included

% >> project structure constants
\str_const:Nn \sections@const@autogen_str  {[autogen].tex}
\str_const:Nn \sections@const@maintext_str {main}
\str_const:Nn \sections@const@appendix_str {appx}
\str_const:Nn \sections@const@sections_str {sections}
\str_const:Nn \sections@const@subsecs_str  {parts}

% >> callbacks
\newcommand{\sections@@onSection@bgn}{}
\newcommand{\sections@@onSection@end}{}
\newcommand{\sections@@onPart@bgn}{}
\newcommand{\sections@@onPart@end}{}

% >>
% -----------------| definitions.end
% -----------------| 
% >>

%%% Mark the section as added
%   #1  - section name
\NewDocumentCommand{\sections@markSectionAsAdded}{ m }
{
    \ifinlist {#1} {\sections@reg@sectionNames_seq} 
    {
        \msg_term:nnx {sections}{section_already_added}{#1}
    } {}
    \seq_gpush:Nn \sections@reg@sectionNames_seq {#1}
}
\msg_new:nnn {sections}{section_already_added}
{
    Error: ~ the ~ following ~ section ~ '#1' ~ is ~ already ~ added.
}


%%% Add appendix path to appendices
%   #1  - appendix path
\NewDocumentCommand{\sections@addAppendix}{ m }
{
    \ifinlist {#1} {\sections@reg@appendixPaths_seq} 
    {
        \msg_term:nnx {sections}{appendix_already_added}{#1}
    } {}
    \seq_gpush:Nn \sections@reg@appendixPaths_seq {#1}
}
\msg_new:nnn {sections}{appendix_already_added}
{
    Error: ~ the ~ following ~ appendix ~ '#1' ~ is ~ already ~ added.
}


\NewDocumentCommand{\sections@check@isInPart}{}
{
    \bool_if:NF \sections@binSubSection
    {
        \msg_term:nn {sections}{not_in_part}
    }
}
\msg_new:nnn {sections}{not_in_part}
{
    Error: ~ the ~ following ~ code ~ cannot ~ be executed ~ out ~ of ~ a ~ section ~ part.
}


%%% append a callback
%   #1  - callback
%   #2  - new code
\NewDocumentCommand{\sections@@@}{ m m }
{
    \g@addto@macro #1 {#2}
}

% >>
% -----------------| 
% -----------------| main.bgn
% >>

%%% start new section's environment
\NewDocumentCommand{\sections@frame@bgn}{ }
{
    \bool_set_true:N  \sections@bInSection
    \bool_set_false:N \sections@binSubSection

    \input{./\sections@const@autogen_str}

    \sections@@onSection@bgn
}

\NewDocumentCommand{\sections@frame@end}{ }
{
    \sections@@onSection@end
    
    \bool_set_false:N \sections@bInSection
    \bool_set_false:N \sections@binSubSection
}

\NewDocumentCommand{\sections@register}{ }
{
    \sections@markSectionAsAdded{\frmNameSection}

    \IfFileExists{\curdir/\sections@const@appendix_str.tex}
    {
        \sections@addAppendix{\frmNameSection}
    }
}

\NewDocumentCommand{\sections@part@bgn}{}
{
    \bool_if:NT \sections@binSubSection
    {
        \msg_term:nn {sections}{part_to_part}
    }

    \bool_set_true:N \sections@binSubSection

    \sections@@onPart@bgn
}
\msg_new:nnn {sections}{part_to_part}
{
    Error: ~ it's ~ not ~ allowed ~ to ~ include ~ one ~ part ~ into ~ atnother ~ one.
}

\NewDocumentCommand{\sections@part@end}{}
{
    \sections@@onPart@end

    \bool_set_false:N \sections@binSubSection
}

% >>
% -----------------| main.end
